// ==UserScript==
// @name Youtube Tools All in one local download mp3 mp4 HIGT QUALITY return dislikes and more
// @name:zh-TW  Youtube 工具 多合一本地下載 MP4、MP3
// @name:zh-HK  Youtube 工具 多合一本地下載 MP4、MP3
// @name:zh-CN  Youtube 工具 多合一本地下載 MP4、MP3
// @name:ja Youtube ツール オールインワンのローカル ダウンロード MP4、MP3
// @name:kr Youtube 도구 올인원 로컬 다운로드 외부 서비스 없이 MP4, MP3
// @name:ar Youtube Tools All in one local download mp3 mp4 HIGT QUALITY return dislikes and more
// @name:bg Youtube-Tools Alles in einem lokalen Download von MP4, MP3.
// @name:cs Nástroje YouTube Vše v jednom místní Stahujte MP4, MP3
// @name:da Youtube-værktøjer Alt i én lokal Download MP4, MP3
// @name:de Youtube-Tools Alles in einem lokalen Download von MP4, MP3
// @name:tel Youtube టూల్స్ అన్నీ ఒకే లోకల్ డౌన్‌లోడ్ MP4, Mp3
// @name:es Youtube Custom Todo en uno Descarga local MP4, MP3.
// @name:en Youtube Tools All in one local download mp3 mp4.
// @name:fr Outils Youtube Tout-en-un local Téléchargez MP4, MP3.
// @name:fr-CA Outils Youtube Tout-en-un local Téléchargez MP4, MP3.
// @name:he כלים של YouTube הכל במקום אחד מקומי הורדה MP4, MP3 באיכות גבוהה ללא שירות חיצוני ועוד.
// @name:hu Youtube Eszközök Minden egy helyen Letöltés MP4, MP3.
// @name:id Alat Youtube Semua dalam satu lokal Unduh MP4, MP3.
// @name:it Strumenti Youtube Tutto in uno Scarica locale MP4, MP3.
// @name:ko Youtube 도구 올인원 로컬 외부 서비스 없이 MP4, MP3
// @name:nb Youtube-verktøy Alt i ett lokalt Last ned MP4, MP3
// @name:nl Youtube Tools Alles in één lokaal Download MP4, MP3
// @name:pl Narzędzia YouTube Wszystko w jednym lokalnym. Pobierz MP4, MP3
// @name:pt-BR Ferramentas do Youtube Tudo em um local Baixe MP4, MP3 DE ALTA QUALIDAD.
// @name:ro YInstrumente Youtube Toate într-un singur local Descărcați MP4, MP3.
// @name:ru Инструменты Youtube Все в одном локальном формате. Загрузите MP4, MP3.
// @name:sk Nástroje YouTube Všetko v jednom miestne Stiahnite si MP4, MP3
// @name:sr Иоутубе алати Све у једном локалном Преузми МП4, МП3
// @name:sv Youtube-verktyg Allt i ett lokalt Ladda ner MP4, MP3
// @name:th เครื่องมือ Youtube ทั้งหมดในที่เดียว ดาวน์โหลด MP4, MP3
// @name:tr Youtube Araçları Hepsi bir arada yerel Harici hizmet olmadan MP4, MP3
// @name:uk Інструменти Youtube Все в одному локальному завантаженні MP4, MP3
// @name:ug Youtube قوراللىرى ھەممىسى بىر يەرلىك چۈشۈرۈش MP4,mp3
// @name:vi Công cụ Youtube Tất cả trong một cục bộ Tải xuống MP4, MP3
// @description:zh-TW Youtube 工具 多合一本地下載 mp4、MP3
// @description:zh-HK Youtube 工具 多合一本地下載 mp4、MP3
// @description:zh-CN Youtube 工具 多合一本地下載 mp4、MP3
// @description:ja    Youtube ツール オールインワン ローカル ダウンロード mp4、MP3 、
// @description:kr    Youtube 도구 올인원 로컬 다운로드 mp4, MP3
// @description:ar    Herramientas de YouTube Todo en uno Descarga local mp4, MP3
// @description:bg    Инструменти за Youtube Всичко в едно локално изтегляне mp4,
// @description:cs    Nástroje YouTube Vše v jednom místní Stahování mp4, MP3
// @description:da    Youtube-værktøjer Alt i ét lokalt Download mp4, MP3
// @description:de    YouTube-Tools Alles in einem lokalen Laden Sie MP4, MP3
// @description:tel   Youtube Tools All in one local Download mp4, MP3 HIGT QUALITY,
// @description:es Youtube tools todo en uno personlizada youtube a tu estilo y descarga MP4 y MP3
// @description:fr Outils Youtube Tout-en-un local Téléchargez des mp4, des MP3
// @description:fr-CA Outils Youtube Tout-en-un local Téléchargez des mp4, des MP3
// @description:he  כלים של YouTube הכל במקום אחד מקומי הורד mp4, MP3
// @description:hu  Youtube Eszközök Minden egyben helyi Letöltés mp4, MP3
// @description:id  Alat Youtube Semua dalam satu lokal Unduh mp4, MP3
// @description:it Strumenti Youtube Tutto in uno locale Scarica mp4, MP3
// @description:ko  Youtube 도구 올인원 로컬 다운로드 mp4, MP3
// @description:nb  YoYoutube-verktøy Alt i ett lokalt Last ned mp4, MP3
// @description:nl    YouTube-tools Alles in één lokaal Download mp4, MP3
// @description:pl    Narzędzia Youtube Wszystko w jednym miejscu Pobierz mp4, MP3
// @description:pt-BR Ferramentas do YouTube Tudo em um só local Baixe mp4, MP3
// @description:ro    Instrumente Youtube Toate într-un singur local Descărcați mp4, MP3
// @description:ru    Инструменты Youtube Все в одном, локально. Загрузите mp4, MP3
// @description:sk    Nástroje YouTube Všetko v jednom miestnom Sťahujte mp4, MP3
// @description:sr    Иоутубе алати Све у једном локалном Преузми мп4, МП3
// @description:sv    Youtube-verktyg Allt i ett lokalt Ladda ner mp4, MP3
// @description:th เครื่องมือ Youtube ทั้งหมดในที่เดียว ดาวน์โหลด mp4, MP3
// @description:tr Youtube Araçları Hepsi bir arada yerel Harici hizmet olmadan mp4, MP3
// @description:uk Інструменти Youtube Все в одному локальному завантаженні mp4, MP3
// @description:ug Youtube قورالىنىڭ ھەممىسى بىر يەرلىك چۈشۈرۈشتە mp4, MP3 HIGH QUAقنى قا
// @description:vi Công cụ Youtube Tất cả trong một cục bộ Tải xuống mp4, MP3
// @description:en Youtube Tools All in one local Download mp4, MP3 HIGT QUALITY
// @description Youtube Tools All in one local Download mp4, MP3 HIGT QUALITY
// @homepage     https://github.com/DeveloperMDCM/
// @version      1.0
// @author       MDCM
// @match        https://*.youtube.com/*
// @exclude      *://music.youtube.com/*
// @exclude      *://*.music.youtube.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=youtube.com
// @grant        GM_info
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        unsafeWindow
// @run-at       document-end
// @compatible chrome
// @compatible firefox
// @compatible opera
// @compatible safari
// @compatible edge
// @compatible brave
// @license MIT
// @namespace https://github.com/DeveloperMDCM/
// ==/UserScript==

(function () {
  'use strict';

  let validoUrl = document.location.href;
  const $e = (el) => document.querySelector(el); // any element
  const $id = (el) => document.getElementById(el); // element by id
  const $m = (el) => document.querySelectorAll(el); // multiple all elements
  const $cl = (el) => document.createElement(el); // create element
  const $sp = (el, pty) => document.documentElement.style.setProperty(el, pty); // set property variable css
  const $ap = (el) => document.body.appendChild(el); // append element
  const apiDislikes = "https://returnyoutubedislikeapi.com/Votes?videoId="; // Api dislikes
  
  function FormatterNumber(num, digits) {
    const lookup = [
      {
        value: 1,
        symbol: '',
      },
      {
        value: 1e3,
        symbol: ' K',
      },
      {
        value: 1e6,
        symbol: ' M',
      },
    ];
    const rx = /\.0+$|(\.[0-9]*[1-9])0+$/;
    const item = lookup
      .slice()
      .reverse()
      .find((item) => {
        return num >= item.value;
      });
    return item
      ? (num / item.value).toFixed(digits).replace(rx, '$1') + item.symbol
      : '0';
  }

  function paramsVideoURL() {
    const parametrosURL = new URLSearchParams(window.location.search); // Url parametros
    return parametrosURL.get('v');
  }

//   Dislikes video
  async function videoDislike() {
   
    validoUrl = document.location.href;

    const validoVentana = $e('#below > ytd-watch-metadata > div');
    if (validoVentana != undefined && document.location.href.split('?v=')[0].includes('youtube.com/watch')) {
        validoUrl = paramsVideoURL();
        const urlShorts = `${apiDislikes}${validoUrl}`;
      try {
        const respuesta = await fetch(urlShorts);
        const datosShort = await respuesta.json();
        const { dislikes } = datosShort;
        const dislikes_content = $e('#top-level-buttons-computed > segmented-like-dislike-button-view-model > yt-smartimation > div > div > dislike-button-view-model > toggle-button-view-model > button-view-model > button');
        if (dislikes_content !== undefined) {
          dislikes_content.style = 'width: 90px';
          dislikes_content.innerHTML = `
            <svg class="svg-dislike-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 13v-8a1 1 0 0 0 -1 -1h-2a1 1 0 0 0 -1 1v7a1 1 0 0 0 1 1h3a4 4 0 0 1 4 4v1a2 2 0 0 0 4 0v-5h3a2 2 0 0 0 2 -2l-1 -5a2 3 0 0 0 -2 -2h-7a3 3 0 0 0 -3 3" /></svg>
            ${FormatterNumber(dislikes, 0)}`;
        }
        console.log('cargando dislikes');
    
      } catch (error) {
        console.log(error);
      }
    }
  }

  // dislikes shorts
  async function shortDislike() {
    validoUrl = document.location.href;
    const validoVentanaShort = document.querySelectorAll(
      '#dislike-button > yt-button-shape > label > div > span'
    );
    if (validoVentanaShort != undefined && document.location.href.split('/')[3] === 'shorts') {
      validoUrl = document.location.href.split('/')[4];
      const urlShorts = `${apiDislikes}${validoUrl}`;
      try {
        const respuesta = await fetch(urlShorts);
        const datosShort = await respuesta.json();
        const { dislikes } = datosShort;
        for (let i = 0; i < validoVentanaShort.length; i++) {
          validoVentanaShort[i].textContent = `${FormatterNumber(
            dislikes,
            0
          )}`;
        }
      } catch (error) {
        console.log(error);
      }
    }
  }

  // Url change in second load
  let prevUrl;
 
  setInterval(() => {
    const svgDislike = $e('.svg-dislike-ico'); // Check svg in dom
    const currUrl = window.location.href;
    if (prevUrl !== undefined && currUrl !== prevUrl && !svgDislike) {
      setTimeout(async() => {
          await videoDislike();
      },2000)
    }
    prevUrl = currUrl;
  }, 1000);



  // Create a Trusted Types policy
  const policy = window.trustedTypes?.createPolicy('default', {
    createHTML: (input) => input,
  });

 
  // Styles for our enhancement panel
  GM_addStyle(` 
        #yt-enhancement-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            background-color: var(--yt-enhance-menu-bg, #ffffff);
            color: var(--yt-enhance-menu-text, #000000);
            border: 1px solid #cccccc;
            border-radius: 8px;
            padding: 15px;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            font-size: var(--yt-enhance-menu-font-size, 14px);
        }
        #yt-enhancement-panel h3 {
            margin-top: 0;
            color: #ff0000;
        }
        .enhancement-option {
            margin-bottom: 10px;
        }
        .color-picker {
            width: 100%;
        }
        .slider {
            width: 100%;
        }
         #toggle-panel {
            position: fixed;
            top: 10px;
            right: 180px;
            z-index: 10000;
            color: white;
            padding: 5px;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            transition: all 0.5s ease;
            width: 43px;
            border-radius: 100px;
        }
             #toggle-panel:hover {
             background-color: #fff;
             border-radius: 100px;
        }
        #icon-menu-settings {
        width: 24px;
        height: 24px;
        cursor: pointer;
        filter: brightness(100);
        user-select: none;
        }

        .tab-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .tab-button {
            background-color: #f0f0f0;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .tab-button.active {
            background-color: #ff0000;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #import-export {
            margin-top: 15px;
        }
        #import-export textarea {
            width: 100%;
            height: 100px;
        }
        #menu-settings-icon {
            cursor: pointer;
            float: right;
            font-size: 20px;
        }
        .theme-option {
            margin-bottom: 15px;
        }
        .theme-option label {
            display: flex;
            align-items: center;
        }
       .theme-option {
    position: relative;
    width: auto;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
}

.theme-preview {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 10px;
    border: 1px solid #000;
    z-index: 1;
}

.theme-option input[type="radio"] {
    position: relative;
    z-index: 2;
    margin-right: 10px;
    cursor: pointer;
}

.theme-name {
    position: relative;
    z-index: 2;
    font-size: 15px;
    color: #fff;
}

.theme-option label {
    display: flex;
    align-items: center;
    width: 100%;
    position: relative;
    z-index: 2;
}

    `);

  // Define themes
  const themes = [
    {
      name: 'Default',
      gradient: '',
      textColor: '',
      raised: '',
      btnTranslate: '#000',
      CurrentProgressVideo: '',
      videoDuration: '',
      colorIcons: '',
      textLogo: '',
    },
    {
      name: 'Midnight Blue',
      gradient: 'linear-gradient(135deg, #1e3a8a, #3b82f6)',
      textColor: '#ffffff',
      raised: '#f00',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
    {
      name: 'Forest Green',
      gradient: 'linear-gradient(135deg, #14532d, #22c55e)',
      textColor: '#ffffff',
      raised: '#303131',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
    {
      name: 'Sunset Orange',
      gradient: 'linear-gradient(135deg, #7c2d12, #f97316)',
      textColor: '#ffffff',
      raised: '#303131',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
    {
      name: 'Royal Purple',
      gradient: 'linear-gradient(135deg, #4c1d95, #8b5cf6)',
      textColor: '#ffffff',
      raised: '#303131',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
    {
      name: 'Cherry Blossom',
      gradient: 'linear-gradient(135deg, #a9005c, #fc008f)',
      textColor: '#ffffff',
      raised: '#fc008f',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
    {
      name: 'Red Dark',
      gradient: 'linear-gradient(135deg, #790909, #f70131)',
      textColor: '#ffffff',
      raised: '#303131',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
    {
      name: 'Raind ',
      gradient: 'linear-gradient(90deg, #3f5efb 0%, #fc466b) 100%',
      textColor: '#ffffff',
      raised: '#303131',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
    {
      name: 'Colombia',
      gradient:
        'linear-gradient(106deg, #fbf63f  0%, #0000bb 45%, #ff0000 99%)',
      textColor: '#ffffff',
      raised: '#303131',
      btnTranslate: '#000',
      CurrentProgressVideo: '#0f0',
      videoDuration: '#fff',
      colorIcons: '#fff',
      textLogo: '#f00',
    },
  ];

  // Create our enhancement panel
  const panel = $cl('div');

  panel.id = 'yt-enhancement-panel';

  // Generate theme options HTML
  const themeOptionsHTML = themes
    .map(
      (theme, index) => `
    <label>
     <div class="theme-option">
    <div class="theme-preview" style="background: ${theme.gradient};"></div>
        <input type="radio"" name="theme" value="${index}" ${
        index === 0 ? 'checked' : ''
      }>
        <span class="theme-name">${theme.name}</span>
</div>
    </label>
    `
    )
    .join('');

  // find atribute dark in dom
  const htmlElement = $e('html');
  const isDarkMode = htmlElement.hasAttribute('dark');
  let isDarkModeActive = isDarkMode;


  // Use Trusted Types to set innerHTML
  const panelHTML = policy
    ? policy.createHTML(`
        <h3>YouTube Tools v1.0 <span id="menu-settings-icon">⚙️</span></h3>
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="general">General</button>
            <button class="tab-button" data-tab="themes">Themes</button>
            <button class="tab-button" data-tab="sidebar">Sidebar</button>
            <button class="tab-button" data-tab="header">Header</button>
        </div>
        <div id="general" class="tab-content active">
                    <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="dark-mode-toggle"> Dark Mode
                </label>
            </div>
            <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="hide-comments-toggle"> Hide Comments
                </label>
            </div>
             <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="hide-sidebar-toggle"> Hide Sidebar
                </label>
            </div>
            <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="autoplay-toggle"> Disable Autoplay
                </label>
            </div>
              <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="dislikes-toggle"> Show Dislikes
                </label>
            </div>
            <div class="enhancement-option">
                <label>Font Size: <span id="font-size-value">16</span>px</label>
                <input type="range" id="font-size-slider" class="slider" min="12" max="24" value="16">
            </div>
             <div class="enhancement-option">
                <label>Video Player Size: <span id="player-size-value">100</span>%</label>
                <input type="range" id="player-size-slider" class="slider" min="50" max="150" value="100">
            </div>
            <div class="enhancement-option">
                <label>Primary Text Color:</label>
                <input type="color" id="primary-color-picker" class="color-picker" value="#000000">
            </div>
            <div class="enhancement-option">
                <label>Secondary Text Color:</label>
                <input type="color" id="secondary-color-picker" class="color-picker" value="#606060">
            </div>
        </div>
        <div id="themes" class="tab-content">
            <h4 style="margin-bottom: 10px">Choose a Theme</h4>
            <p>${isDarkModeActive ? '' : 'activate dark mode to use themes'}</p>
            ${themeOptionsHTML}
        </div>
        <div id="sidebar" class="tab-content">
            <!-- Sidebar content here -->
        </div>
        <div id="header" class="tab-content">
            <!-- Header content here -->
        </div>
        <div id="menu-settings" class="tab-content">
            <h4>Menu Appearance</h4>
            <div class="enhancement-option">
                <label>Menu Background Color:</label>
                <input type="color" id="menu-bg-color-picker" class="color-picker" value="#ffffff">
            </div>
            <div class="enhancement-option">
                <label>Menu Text Color:</label>
                <input type="color" id="menu-text-color-picker" class="color-picker" value="#000000">
            </div>
            <div class="enhancement-option">
                <label>Menu Font Size: <span id="menu-font-size-value">14</span>px</label>
                <input type="range" id="menu-font-size-slider" class="slider" min="10" max="20" value="14">
            </div>
        </div>
        <div id="import-export">
            <button id="export-config">Export Configuration</button>
            <button id="import-config">Import Configuration</button>
            <textarea id="config-data" placeholder="Paste configuration here to import"></textarea>
        </div>
    `)
    : `
          <h3>YouTube Tools v1.0 <span id="menu-settings-icon">⚙️</span></h3>
        <div class="tab-buttons">
            <button class="tab-button active" data-tab="general">General</button>
            <button class="tab-button" data-tab="themes">Themes</button>
            <button class="tab-button" data-tab="sidebar">Sidebar</button>
            <button class="tab-button" data-tab="header">Header</button>
        </div>
        <div id="general" class="tab-content active">
                    <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="dark-mode-toggle"> Dark Mode
                </label>
            </div>
            <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="hide-comments-toggle"> Hide Comments
                </label>
            </div>
             <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="hide-sidebar-toggle"> Hide Sidebar
                </label>
            </div>
            <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="autoplay-toggle"> Disable Autoplay
                </label>
            </div>
            <div class="enhancement-option">
                <label>
                    <input type="checkbox" id="dislikes-toggle"> Show Dislikes
                </label>
            </div>
            <div class="enhancement-option">
                <label>Font Size: <span id="font-size-value">16</span>px</label>
                <input type="range" id="font-size-slider" class="slider" min="12" max="24" value="16">
            </div>
             <div class="enhancement-option">
                <label>Video Player Size: <span id="player-size-value">100</span>%</label>
                <input type="range" id="player-size-slider" class="slider" min="50" max="150" value="100">
            </div>
            <div class="enhancement-option">
                <label>Primary Text Color:</label>
                <input type="color" id="primary-color-picker" class="color-picker" value="#000000">
            </div>
            <div class="enhancement-option">
                <label>Secondary Text Color:</label>
                <input type="color" id="secondary-color-picker" class="color-picker" value="#606060">
            </div>
        </div>
        <div id="themes" class="tab-content">
            <h4 style="margin-bottom: 10px">Choose a Theme</h4>
            <p>${isDarkModeActive ? '' : 'activate dark mode to use themes'}</p>
            ${themeOptionsHTML}
        </div>
        <div id="sidebar" class="tab-content">
            <!-- Sidebar content here -->
        </div>
        <div id="header" class="tab-content">
            <!-- Header content here -->
        </div>
        <div id="menu-settings" class="tab-content">
            <h4>Menu Appearance</h4>
            <div class="enhancement-option">
                <label>Menu Background Color:</label>
                <input type="color" id="menu-bg-color-picker" class="color-picker" value="#ffffff">
            </div>
            <div class="enhancement-option">
                <label>Menu Text Color:</label>
                <input type="color" id="menu-text-color-picker" class="color-picker" value="#000000">
            </div>
            <div class="enhancement-option">
                <label>Menu Font Size: <span id="menu-font-size-value">14</span>px</label>
                <input type="range" id="menu-font-size-slider" class="slider" min="10" max="20" value="14">
            </div>
        </div>
        <div id="import-export">
            <button id="export-config">Export Configuration</button>
            <button id="import-config">Import Configuration</button>
            <textarea id="config-data" placeholder="Paste configuration here to import"></textarea>
        </div>
    `;

  panel.innerHTML = panelHTML;
  $ap(panel);
  // Create toggle button
  const toggleButton = $cl('div');
  toggleButton.id = 'toggle-panel';
  const icon = $cl('img');
  icon.id = 'icon-menu-settings';
  icon.src =
    'https://cdn.iconscout.com/icon/premium/png-512-thumb/settings-782-1095915.png?f=webp&w=256';

  toggleButton.appendChild(icon);

  // Add panel and toggle button to the page
  $ap(panel);
  $ap(toggleButton);

  // Toggle panel visibility
  let openMenu = false;
  toggleButton.addEventListener('click', () => {
    openMenu = !openMenu;
    openMenu
      ? (toggleButton.style.backgroundColor = '#f00')
      : (toggleButton.style.backgroundColor = 'transparent');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  });

  // Tab functionality
  const tabButtons = $m('.tab-button');
  const tabContents = $m('.tab-content');

  tabButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const tabName = button.getAttribute('data-tab');
      tabButtons.forEach((btn) => btn.classList.remove('active'));
      tabContents.forEach((content) => content.classList.remove('active'));
      button.classList.add('active');
      $id(tabName).classList.add('active');
    });
  });

  // Menu settings icon functionality
  $id('menu-settings-icon').addEventListener('click', () => {
    tabButtons.forEach((btn) => btn.classList.remove('active'));
    tabContents.forEach((content) => content.classList.remove('active'));
    $id('menu-settings').classList.add('active');
  });

  // Function to save settings
  function saveSettings() {
    const settings = {
      theme: $e('input[name="theme"]:checked').value,
      dislikes: $id('dislikes-toggle').checked,
      darkMode: $id('dark-mode-toggle').checked,
      hideComments: $id('hide-comments-toggle').checked,
      hideSidebar: $id('hide-sidebar-toggle').checked,
      disableAutoplay: $id('autoplay-toggle').checked,
      fontSize: $id('font-size-slider').value,
      playerSize: $id('player-size-slider').value,
      primaryColor: $id('primary-color-picker').value,
      secondaryColor: $id('secondary-color-picker').value,
      menuBgColor: $id('menu-bg-color-picker').value,
      menuTextColor: $id('menu-text-color-picker').value,
      menuFontSize: $id('menu-font-size-slider').value,
    };
    GM_setValue('ytSettingsMDCM', JSON.stringify(settings));
  }

  // Function to load settings
  function loadSettings() {
    const settings = JSON.parse(GM_getValue('ytSettingsMDCM', '{}'));
    if (settings.theme) {
      $e(`input[name="theme"][value="${settings.theme}"]`).checked = true;
    }
    $id('dislikes-toggle').checked = settings.dislikes || false;
    $id('dark-mode-toggle').checked = settings.darkMode || false;
    $id('hide-comments-toggle').checked = settings.hideComments || false;
    $id('hide-sidebar-toggle').checked = settings.hideSidebar || false;
    $id('autoplay-toggle').checked = settings.disableAutoplay || false;
    $id('font-size-slider').value = settings.fontSize || 16;
    $id('player-size-slider').value = settings.playerSize || 100;
    $id('primary-color-picker').value = settings.primaryColor || '#000000';
    $id('secondary-color-picker').value = settings.secondaryColor || '#606060';
    $id('menu-bg-color-picker').value = settings.menuBgColor || '#ffffff';
    $id('menu-text-color-picker').value = settings.menuTextColor || '#000000';
    $id('menu-font-size-slider').value = settings.menuFontSize || 14;
    updateSliderValues();
    setTimeout(() => {
      applySettings();
      if(settings.dislikes) {
          videoDislike();
          shortDislike(); 
      }
    }, 500);
  }
  // Function to update slider values
  function updateSliderValues() {
    $id('font-size-value').textContent = $id('font-size-slider').value;
    $id('player-size-value').textContent = $id('player-size-slider').value;
    $id('menu-font-size-value').textContent = $id(
      'menu-font-size-slider'
    ).value;
  }

  // Function to apply settings
  function applySettings() {
    const settings = {
      theme: $e('input[name="theme"]:checked').value,
      dislikes: $id('dislikes-toggle').checked,
      darkMode: $id('dark-mode-toggle').checked,
      hideComments: $id('hide-comments-toggle').checked,
      hideSidebar: $id('hide-sidebar-toggle').checked,
      disableAutoplay: $id('autoplay-toggle').checked,
      fontSize: $id('font-size-slider').value,
      playerSize: $id('player-size-slider').value,
      primaryColor: $id('primary-color-picker').value,
      secondaryColor: $id('secondary-color-picker').value,
      menuBgColor: $id('menu-bg-color-picker').value,
      menuTextColor: $id('menu-text-color-picker').value,
      menuFontSize: $id('menu-font-size-slider').value,
    };
  
    // Hide comments
    const commentsSection = $id('comments');
    if (commentsSection) {
      commentsSection.style.display = settings.hideComments ? 'none' : 'block';
    }

    // Hide sidebar
    const sidebarSection = $id('secondary');
    if (sidebarSection) {
      sidebarSection.style.display = settings.hideSidebar ? 'none' : 'block';
    }

    // Disable autoplay
    const autoplayToggle = $e('.ytp-autonav-toggle-button');
    if (autoplayToggle) {
      const isCurrentlyOn =
        autoplayToggle.getAttribute('aria-checked') === 'true';
      if (settings.disableAutoplay && isCurrentlyOn) {
        autoplayToggle.click();
      } else if (!settings.disableAutoplay && !isCurrentlyOn) {
        autoplayToggle.click();
      }
    }

    // Adjust font size
    $e('body').style.fontSize = `${settings.fontSize}px`;

    // Adjust player size
    const player = $e('video');
    if (player) {
      player.style.transform = `scale(${settings.playerSize / 100})`;
    }

    // Apply menu appearance settings
    $sp('--yt-enhance-menu-bg', settings.menuBgColor);
    $sp('--yt-enhance-menu-text', settings.menuTextColor);
    $sp('--yt-enhance-menu-font-size', `${settings.menuFontSize}px`);

    // Apply theme
    const selectedTheme = themes[settings.theme];
    function checkDarkMode() {
      if (isDarkMode) {
        // Apply theme
        $sp('--yt-spec-base-background', selectedTheme.gradient);
        $sp('--yt-spec-text-primary', selectedTheme.textColor);
        $sp('--yt-spec-text-secondary', selectedTheme.textColor);
        $sp('--yt-spec-menu-background', selectedTheme.gradient);
        $sp('--yt-spec-icon-inactive', selectedTheme.textColor);
        $sp('--yt-spec-brand-icon-inactive', selectedTheme.textColor);
        $sp('--yt-spec-brand-icon-active', selectedTheme.gradient);
        $sp('--yt-spec-static-brand-red', selectedTheme.gradient); // line current time
        $sp('--yt-spec-raised-background', selectedTheme.raised);
        $sp('--yt-spec-static-brand-red', selectedTheme.CurrentProgressVideo);
        $sp('--yt-spec-static-brand-white', selectedTheme.textColor);
        $sp('--ytd-searchbox-background', selectedTheme.gradient);
        $sp('--ytd-searchbox-text-color', selectedTheme.textColor);

        GM_addStyle(`
        #background.ytd-masthead { background: ${
          selectedTheme.gradient
        }  !important; }
        .ytp-swatch-background-color {
        background: ${
          selectedTheme.gradient === '' ? '#f00' : selectedTheme.gradient
        } !important;
      }
 .ytd-shorts, #page-manager.ytd-app {
     background: ${selectedTheme.gradient};
     }
        ytd-engagement-panel-title-header-renderer[shorts-panel] #header.ytd-engagement-panel-title-header-renderer {
        background: ${selectedTheme.gradient}  !important;}
        .buttons-tranlate {
         background: ${selectedTheme.btnTranslate} !important;
        }
        .badge-shape-wiz--thumbnail-default {
        color: ${selectedTheme.videoDuration} !important;
         background: ${selectedTheme.gradient} !important;
        }
         #logo-icon {
         color:  ${selectedTheme.textLogo} !important;
      }
      .yt-spec-button-shape-next--overlay.yt-spec-button-shape-next--text {
        color:  ${selectedTheme.iconsColor} !important;
      }
      .ytd-topbar-menu-button-renderer #button.ytd-topbar-menu-button-renderer {
        color:  ${selectedTheme.iconsColor} !important;
      }
      .yt-spec-icon-badge-shape--style-overlay .yt-spec-icon-badge-shape__icon {
        color:  ${selectedTheme.iconsColor} !important;
      }
      .ytp-svg-fill {
        fill:  ${selectedTheme.iconsColor} !important;
      }
      #ytp-id-30,#ytp-id-17,#ytp-id-19,#ytp-id-20{
        fill:  ${selectedTheme.iconsColor} !important;
      }
        `);
      }
    }

    checkDarkMode();
    let currentUrl = window.location.href;
    let urlCheckInterval = setInterval(function () {
      if (window.location.href !== currentUrl) {
        currentUrl = window.location.href;
        checkUrlChange();
      }
    }, 1000);

    function checkUrlChange() {
      setTimeout(() => {
        applySettings();
      }, 1000);
      clearInterval(urlCheckInterval);
    }

    let traducido; // Texto traducido
    let urlLista; // Url lista
    async function traductor() {
      const texto = $m('#content-text');
      let o = `?client=dict-chrome-ex&sl=auto&tl=${navigator.language}&q=`;
      for (let i = 0; i < texto.length; i++) {
        const botonTraducir = $cl('BUTTON');
        botonTraducir.classList.add('buttons-tranlate');
        botonTraducir.textContent = 'Translate';
        botonTraducir.setAttribute('id', `btn${i}`);
        texto[i].insertAdjacentElement('afterend', botonTraducir);
        const mdcm = $m(`.buttons-tranlate`);
        mdcm[i].onclick = function () {
          traducido = o;
          urlLista = traducido + texto[i].textContent;
          fetch('https://translate.googleapis.com/translate_a/t' + urlLista) //API
            .then((response) => response.json())
            .then((datos) => {
              texto[i].textContent = datos[0][0];
              mdcm[i].textContent = 'Translated';
            });
        };
      }
    }
    GM_addStyle(`
        .buttons-tranlate {
         background: ${selectedTheme.btnTranslate};
         font-size: 10px;
         border: none;
         color: #fbf4f4 !important;
         padding: 3px 0;
         margin-left: 10px;
         width: 70px;
         border-radius: 10px;}
         .buttons-tranlate:hover {
         cursor: pointer;
         background-color: #6b6b6b;}
        `);
    // clean buttoms dom 
    function limpiarHTML(element) {
      const buttons = $m(`${element}`);
      [].forEach.call(buttons, function (buttons) {
        buttons.remove();
      });
      traductor();
    }

    window.onscroll = () => {
      const divEl = $e('#content-text');
      const divEl2 = $e(
        'ytd-item-section-renderer[static-comments-header] #contents'
      );
      if (divEl != undefined || divEl2 != undefined) {
        limpiarHTML('.buttons-tranlate');
      }
    };

    const targetNode = $e('body');

    if (targetNode != undefined) {
      // config observe
      const config = { childList: true, subtree: true };

      // instance  MutationObserver
      const observer = new MutationObserver((mutationsList, observer) => {
        // Observe
        for (let mutation of mutationsList) {
          if (mutation.type === 'childList') {
            // Element find
            const targetElement = $e(
              'ytd-item-section-renderer[static-comments-header] #contents'
            );

            if (targetElement) {
              targetElement.style.background = `${selectedTheme.gradient}`;
            }
          }
        }
      });

      // Inicia la observación del nodo con las opciones configuradas
      observer.observe(targetNode, config);
    }
    saveSettings();
  }


  // Add event listeners to all inputs
  const inputs = $m('input');
  inputs.forEach((input) => {
    input.addEventListener('change', applySettings);
    if (input.type === 'range') {
      input.addEventListener('change', () => {
        updateSliderValues();
        applySettings();
      });
    }
  });

  // Export configuration

//   Settings saved
//   const settings = GM_getValue('ytSettingsMDCM', '{}');
//   $id('config-data').value = settings;

  $id('export-config').addEventListener('click', () => {
    const settings = GM_getValue('ytSettingsMDCM', '{}');
    $id('config-data').value = settings;
    const configData = settings;
    try {
      JSON.parse(configData); // Validate JSON
      GM_setValue('ytSettingsMDCM', configData);
      alert('Configuration export successfully!');
    } catch (e) {
      alert('Invalid configuration data. Please check and try again.');
    }
  });
  // Import configuration
  $id('import-config').addEventListener('click', () => {
    const configData = $id('config-data').value;
    try {
      JSON.parse(configData); // Validate JSON
      GM_setValue('ytSettingsMDCM', configData);
      alert('Configuration imported successfully!');
      window.location.reload();
    } catch (e) {
      alert('Invalid configuration data. Please check and try again.');
    }
  });
  panel.style.display = 'none'; // Ensure panel is hidden on load
  
  // Load saved settings
  // Visible element DOM
  function checkElement(selector, callback) {
    const interval = setInterval(() => {
      if ($e(selector)) {
        clearInterval(interval);

        callback();
      }
    }, 100);
  }

  checkElement('ytd-topbar-menu-button-renderer', loadSettings);

})();
